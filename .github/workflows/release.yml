name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v2.1.0)'
        required: true

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Download and verify modules
        run: go mod download && go mod verify

      - name: Run tests
        run: go test -v -race ./...

  release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Determine tag
        id: tag
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if [ -n "$INPUT_TAG" ]; then
            TAG="$INPUT_TAG"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          if [ -z "$TAG" ]; then
            echo "::error::No tag provided"
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Download modules
        run: go mod download

      - name: Cross-compile binaries
        run: |
          mkdir -p release-tree/bin
          targets="darwin/amd64 darwin/arm64 linux/amd64 linux/arm64 windows/amd64"
          for target in $targets; do
            GOOS="${target%/*}"
            GOARCH="${target#*/}"
            output="save-todos-${GOOS}-${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output="${output}.exe"
            fi
            echo "Building ${output}..."
            GOOS="$GOOS" GOARCH="$GOARCH" go build -trimpath -ldflags="-s -w" \
              -o "release-tree/bin/${output}" ./cmd/save-todos
          done

      - name: Create wrapper script
        run: |
          cat > release-tree/bin/save-todos << 'EOF'
          #!/usr/bin/env sh
          set -e
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64)  ARCH="amd64" ;;
            aarch64) ARCH="arm64" ;;
            arm64)   ARCH="arm64" ;;
            *)       echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
          esac
          case "$OS" in
            darwin)  OS="darwin" ;;
            linux)   OS="linux" ;;
            mingw*|msys*|cygwin*) OS="windows" ;;
            *)       echo "Unsupported OS: $OS" >&2; exit 1 ;;
          esac
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          BINARY="${SCRIPT_DIR}/save-todos-${OS}-${ARCH}"
          [ "$OS" = "windows" ] && BINARY="${BINARY}.exe"
          if [ ! -x "$BINARY" ]; then
            echo "Binary not found: $BINARY" >&2
            echo "Platform: ${OS}/${ARCH}" >&2
            exit 1
          fi
          exec "$BINARY" "$@"
          EOF
          chmod +x release-tree/bin/save-todos

      - name: Copy plugin metadata
        run: |
          cp -r .claude-plugin release-tree/
          cp -r hooks release-tree/
          for f in README.md LICENSE CHANGELOG.md; do
            [ -f "$f" ] && cp "$f" release-tree/
          done

      - name: Push to releases branch
        id: push-releases
        run: |
          cd release-tree
          git init
          git checkout --orphan releases
          git add -A
          git -c user.name="github-actions[bot]" \
              -c user.email="github-actions[bot]@users.noreply.github.com" \
              commit -m "Release ${{ steps.tag.outputs.tag }}"
          SHA=$(git rev-parse HEAD)
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          git remote add origin \
            "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          git push --force origin releases
          echo "::notice::Pushed releases branch with SHA: $SHA"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd release-tree
          sha256sum bin/save-todos-* > checksums-sha256.txt
          gh release create "${{ steps.tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --title "${{ steps.tag.outputs.tag }}" \
            --generate-notes \
            bin/save-todos-* checksums-sha256.txt

      - name: Print marketplace update instructions
        run: |
          echo "============================================"
          echo "  RELEASE COMPLETE: ${{ steps.tag.outputs.tag }}"
          echo "============================================"
          echo ""
          echo "Update prial-plugins marketplace.json with:"
          echo ""
          echo "  \"source\": {"
          echo "    \"source\": \"github\","
          echo "    \"repo\": \"JamesPrial/todo-log\","
          echo "    \"ref\": \"releases\","
          echo "    \"sha\": \"${{ steps.push-releases.outputs.sha }}\""
          echo "  }"
          echo ""
          echo "============================================"
